Vue 使用 Defer 优化白屏时间
================================

在 vue 项目中，当页面中有大量组件需要渲染时，会导致页面白屏时间过长，为了优化这个问题，可以使用 ``defer`` 来延迟渲染组件。

创建 ``defer.js`` 文件并添加以下代码：

.. code-block:: javascript

    import { ref, onUnmounted } from "vue";

    /**
    * 延迟执行
    * @param {number} maxFrameCount 最大帧数
    * @returns {Function} 返回一个函数，接收一个参数 n，当帧数大于等于 n 时返回 true
    */
    export function useDefer(maxFrameCount = 1000) {
        let frameCount = ref(0);
        let rafId = null;

        function updateFrameCount() {
        requestAnimationFrame(() => {
            rafId = frameCount.value++;
            if (frameCount.value >= maxFrameCount) {
            return;
            }
            updateFrameCount();
        });
        }

        updateFrameCount();

        onUnmounted(() => {
        cancelAnimationFrame(rafId);
        });

        return function (n) {
        return frameCount.value >= n;
        };
    }

在组件中使用：

.. code-block:: vue

    <template>
        <div v-for="i in 1000" >
        <heavy-comp v-if="defer(i)">{{ i }}</heavy-comp>
        </div>
    </template>

    <script setup>
    import HeavyComp from "./components/HeavyComp.vue";
    import { useDefer } from "./defer.js";
    const defer = useDefer();
    </script>
